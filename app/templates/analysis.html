{% extends "layout.html" %}

{% block title %}Analyse - SEO Internal Linking Tool{% endblock %}

{% block styles %}
<style>
    .upload-section {
        background-color: var(--bs-gray-100);
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    .progress-container {
        margin-top: 2rem;
    }
    .progress-bar {
        transition: width 0.5s ease;
    }
</style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h1 class="mb-4">Analyse de maillage interne</h1>
        
        <div x-data="analysisApp()" x-init="init()" class="analysis-app">
            <!-- Notification pour l'import GSC -->
            <div x-show="gscNotificationVisible" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                <strong>Données GSC importées !</strong> Les données de Google Search Console ont été automatiquement importées et sont prêtes à être utilisées pour l'analyse.
                <button type="button" class="btn-close" @click="gscNotificationVisible = false" aria-label="Close"></button>
            </div>
            
            <div x-show="!jobId">
                <!-- Affichage des fichiers pré-remplis -->
                <div class="alert alert-info mb-3" x-show="contentFilePath || linksFilePath || gscFilePath">
                    <h5><i class="bi bi-info-circle"></i> Fichiers pré-remplis détectés</h5>
                    <p>Les fichiers suivants ont été pré-sélectionnés :</p>
                    <ul>
                        <li x-show="contentFilePath">Fichier de contenu : <strong x-text="contentFilePath"></strong></li>
                        <li x-show="linksFilePath">Fichier de liens : <strong x-text="linksFilePath"></strong></li>
                        <li x-show="gscFilePath">Fichier GSC : <strong x-text="gscFilePath"></strong></li>
                    </ul>
                    <button class="btn btn-primary" @click="startAnalysisWithPrefilledFiles">Lancer l'analyse avec ces fichiers</button>
                </div>
                
                <div class="upload-section">
                    <h3>Téléchargement des fichiers</h3>
                    
                    <!-- Formulaire standard pour le téléchargement de fichiers -->
                    <div x-show="!contentFilePath">
                        <div class="mb-3">
                            <label for="contentFile" class="form-label">Fichier de contenu (obligatoire)</label>
                            <input class="form-control" type="file" id="contentFile" @change="handleContentFileChange">
                            <div class="form-text">Format Excel avec colonnes: Adresse, Segments, Extracteur 1 1</div>
                        </div>
                    </div>
                
                <div x-show="!linksFilePath">
                    <div class="mb-3">
                        <label for="linksFile" class="form-label">Fichier de liens existants (optionnel)</label>
                        <input class="form-control" type="file" id="linksFile" @change="handleLinksFileChange">
                        <div class="form-text">Format Excel avec colonnes: Source, Destination</div>
                    </div>
                </div>
                
                <div x-show="!gscFilePath">
                    <div class="mb-3">
                        <label for="gscFile" class="form-label">Fichier GSC (optionnel)</label>
                        <input class="form-control" type="file" id="gscFile" @change="handleGscFileChange">
                        <div class="form-text">Format Excel avec colonnes: query, page (format requis pour l'analyse des ancres)</div>
                    </div>
                </div>
                
                <div x-show="gscFilePath" class="mb-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <label class="form-label">Fichier GSC sélectionné</label>
                            <p class="text-success"><i class="bi bi-check-circle me-2"></i><strong x-text="gscFilePath"></strong></p>
                        </div>
                        <button @click="clearGscData" class="btn btn-outline-danger btn-sm" title="Effacer les données GSC">
                            <i class="bi bi-trash"></i> Effacer
                        </button>
                    </div>
                </div>
                </div>
            </div>

            <div class="upload-section">
                <h3>Configuration de l'analyse</h3>
                <div class="mb-3">
                    <label for="minSimilarity" class="form-label">Score minimal de similarité</label>
                    <input type="range" class="form-range" min="0.1" max="0.9" step="0.05" id="minSimilarity" x-model="config.minSimilarity">
                    <div class="d-flex justify-content-between">
                        <span>0.1</span>
                        <span x-text="config.minSimilarity"></span>
                        <span>0.9</span>
                    </div>
                    <div class="form-text">Plus la valeur est élevée, plus les suggestions seront pertinentes mais moins nombreuses</div>
                </div>
                <div class="mb-3">
                    <label for="anchorSuggestions" class="form-label">Nombre de suggestions d'ancres</label>
                    <input type="number" class="form-control" id="anchorSuggestions" min="1" max="5" x-model="config.anchorSuggestions">
                </div>
            </div>
            
            <div class="upload-section">
                <h3>URL prioritaires</h3>
                <p class="text-muted">Définissez une liste d'URL prioritaires dont le PageRank doit être maintenu ou amélioré lors de l'optimisation du maillage interne.</p>
                
                <div class="mb-3">
                    <label for="priorityUrls" class="form-label">Liste des URL prioritaires</label>
                    <textarea class="form-control" id="priorityUrls" rows="4" placeholder="Entrez une URL par ligne" x-model="config.priorityUrls"></textarea>
                    <div class="form-text">Ces URL seront protégées lors de la génération du plan de maillage. Le système s'assurera que leur PageRank ne diminue pas.</div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="priorityUrlsStrict" x-model="config.priorityUrlsStrict">
                        <label class="form-check-label" for="priorityUrlsStrict">Mode strict</label>
                    </div>
                    <div class="form-text">Si activé, le système garantira que les URL prioritaires améliorent leur PageRank. Sinon, il s'assurera simplement qu'elles ne perdent pas de PageRank.</div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button class="btn btn-primary" @click="startAnalysis" :disabled="!contentFilePath">Lancer l'analyse</button>
                </div>
            </div>
        </div>

        <div x-show="jobId" class="progress-container">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Progression de l'analyse</h5>
                    <span class="badge" :class="getStatusBadgeClass(jobStatus?.status)" x-text="getStatusLabel(jobStatus?.status)"></span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar" role="progressbar" :style="'width: ' + (jobStatus?.progress || 0) + '%'" :aria-valuenow="jobStatus?.progress || 0" aria-valuemin="0" aria-valuemax="100" x-text="(jobStatus?.progress || 0) + '%'"></div>
                        </div>
                    </div>
                    <p class="mb-2"><strong>Statut actuel:</strong> <span x-text="jobStatus?.message || 'En attente...'"></span></p>
                    <p class="mb-2"><strong>Démarré le:</strong> <span x-text="formatDate(jobStatus?.start_time)"></span></p>
                    <p class="mb-0" x-show="jobStatus?.end_time"><strong>Terminé le:</strong> <span x-text="formatDate(jobStatus?.end_time)"></span></p>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-danger" @click="stopAnalysis" x-show="jobStatus?.status === 'running'">Arrêter l'analyse</button>
                        <button class="btn btn-warning" @click="forceCompleteAnalysis" x-show="jobStatus?.status === 'running'">Forcer la fin de l'analyse</button>
                        <button class="btn btn-success" @click="viewResults" x-show="jobStatus?.status === 'completed'">Voir les résultats</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Journal d'activité</h5>
                </div>
                <div class="card-body">
                    <div class="log-container">
                        <ul class="list-group list-group-flush">
                            <template x-for="(log, index) in logHistory" :key="index">
                                <li class="list-group-item d-flex align-items-center">
                                    <span class="me-2" x-html="getLogIcon(log)"></span>
                                    <span x-text="log"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
        function analysisApp() {
            return {
                contentFilePath: null,
                linksFilePath: null,
                gscFilePath: null,
                config: {
                    minSimilarity: 0.2,
                    anchorSuggestions: 3,
                    priorityUrls: '',
                    priorityUrlsStrict: false
                },
                jobId: null,
                jobStatus: null,
                logHistory: [],
                socket: null,
                gscNotificationVisible: false,
                
                // Initialisation à partir des paramètres d'URL
                init() {
                    // Récupérer les paramètres d'URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const contentParam = urlParams.get('content');
                    const linksParam = urlParams.get('links');
                    const gscParam = urlParams.get('gsc_file');
                    const autoStartParam = urlParams.get('auto_start');
                    
                    // Si des paramètres sont présents, les utiliser pour pré-remplir les champs
                    if (contentParam) {
                        this.contentFilePath = contentParam;
                        console.log('Fichier de contenu pré-rempli:', contentParam);
                    }
                    
                    if (linksParam) {
                        this.linksFilePath = linksParam;
                        console.log('Fichier de liens pré-rempli:', linksParam);
                    }
                    
                    // Vérifier d'abord si un fichier GSC est spécifié dans l'URL
                    let hasGscFile = false;
                    if (gscParam && gscParam !== 'undefined' && gscParam !== 'null') {
                        this.gscFilePath = gscParam;
                        console.log('Fichier GSC pré-rempli depuis URL:', gscParam);
                        hasGscFile = true;
                        
                        // Stocker le chemin dans localStorage pour le rendre persistant
                        localStorage.setItem('gscFilePath', gscParam);
                    } 
                    // Sinon, vérifier s'il y a un fichier GSC dans le localStorage
                    else {
                        const storedGscPath = localStorage.getItem('gscFilePath');
                        if (storedGscPath && storedGscPath !== 'undefined' && storedGscPath !== 'null') {
                            this.gscFilePath = storedGscPath;
                            console.log('Fichier GSC récupéré depuis localStorage:', storedGscPath);
                            hasGscFile = true;
                        } else {
                            // Réinitialiser le chemin si la valeur est invalide
                            this.gscFilePath = null;
                            localStorage.removeItem('gscFilePath');
                            console.log('Aucun fichier GSC valide trouvé');
                        }
                    }
                    
                    // Si un fichier GSC a été trouvé (URL ou localStorage)
                    if (hasGscFile) {
                        // Afficher une notification pour informer l'utilisateur que les données GSC ont été importées
                        this.showGscImportNotification();
                        
                        // Si auto_start est présent et qu'un fichier de contenu est fourni, lancer automatiquement l'analyse
                        if (autoStartParam === 'true' && contentParam) {
                            // Laisser le temps à l'interface de se charger
                            setTimeout(() => {
                                this.startAnalysisWithPrefilledFiles();
                            }, 500);
                        }
                    }
                },
                
                handleContentFileChange(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    fetch('/api/upload/content', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.contentFilePath = data.saved_path;
                        console.log('Fichier de contenu téléchargé:', data);
                    })
                    .catch(error => {
                        console.error('Erreur lors du téléchargement du fichier de contenu:', error);
                        alert('Erreur lors du téléchargement du fichier de contenu. Vérifiez le format du fichier.');
                    });
                },
                
                handleLinksFileChange(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    fetch('/api/upload/links', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.linksFilePath = data.saved_path;
                        console.log('Fichier de liens téléchargé:', data);
                    })
                    .catch(error => {
                        console.error('Erreur lors du téléchargement du fichier de liens:', error);
                        alert('Erreur lors du téléchargement du fichier de liens. Vérifiez le format du fichier.');
                    });
                },
                
                handleGscFileChange(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    fetch('/api/upload/gsc', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Mettre à jour le chemin du fichier GSC
                        this.gscFilePath = data.saved_path;
                        console.log('Fichier GSC téléchargé:', data);
                        
                        // Stocker le nouveau chemin dans localStorage pour le rendre persistant
                        localStorage.setItem('gscFilePath', data.saved_path);
                        
                        // Afficher une notification pour informer l'utilisateur que les données GSC ont été importées
                        this.showGscImportNotification();
                    })
                    .catch(error => {
                        console.error('Erreur lors du téléchargement du fichier GSC:', error);
                        alert('Erreur lors du téléchargement du fichier GSC. Vérifiez le format du fichier.');
                    });
                },
                
                startAnalysis() {
                    if (!this.contentFilePath) {
                        alert('Veuillez télécharger un fichier de contenu.');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('content_file', this.contentFilePath);
                    if (this.linksFilePath) formData.append('links_file', this.linksFilePath);
                    if (this.gscFilePath) formData.append('gsc_file', this.gscFilePath);
                    formData.append('config', JSON.stringify(this.config));
                    
                    fetch('/api/analyze', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.jobId = data.job_id;
                        console.log('Analyse démarrée:', data);
                        this.connectWebSocket();
                    })
                    .catch(error => {
                        console.error('Erreur lors du démarrage de l\'analyse:', error);
                        alert('Erreur lors du démarrage de l\'analyse.');
                    });
                },
                
                connectWebSocket() {
                    // Créer une connexion WebSocket
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/${this.jobId}`;
                    
                    this.socket = new WebSocket(wsUrl);
                    
                    this.socket.onopen = () => {
                        console.log('WebSocket connecté');
                    };
                    
                    this.socket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.jobStatus = data;
                        
                        // Ajouter le message au journal s'il est nouveau
                        if (data.message && (this.logHistory.length === 0 || this.logHistory[this.logHistory.length - 1] !== data.message)) {
                            this.logHistory.push(data.message);
                        }
                        
                        // Redirection automatique vers la page de résultats si l'analyse est terminée
                        if (data.status === 'completed') {
                            this.logHistory.push('Redirection automatique vers la page de résultats...');
                            setTimeout(() => {
                                window.location.href = `/results/${this.jobId}`;
                            }, 1000);
                        }
                    };
                    
                    this.socket.onerror = (error) => {
                        console.error('Erreur WebSocket:', error);
                        this.fallbackToHttp();
                    };
                    
                    this.socket.onclose = () => {
                        console.log('WebSocket déconnecté');
                        // Vérifier si l'analyse est toujours en cours
                        if (this.jobStatus && this.jobStatus.status === 'running') {
                            this.fallbackToHttp();
                        }
                    };
                },
                
                fallbackToHttp() {
                    // Utiliser HTTP pour récupérer le statut
                    console.log('Fallback HTTP: Vérification du statut de la tâche');
                    
                    const checkStatus = () => {
                        fetch(`/api/job/${this.jobId}`)
                            .then(response => response.json())
                            .then(data => {
                                this.jobStatus = data;
                                
                                // Ajouter le message au journal s'il est nouveau
                                if (data.message && (this.logHistory.length === 0 || this.logHistory[this.logHistory.length - 1] !== data.message)) {
                                    this.logHistory.push(data.message);
                                }
                                
                                // Redirection automatique vers la page de résultats si l'analyse est terminée
                                if (data.status === 'completed') {
                                    this.logHistory.push('Redirection automatique vers la page de résultats...');
                                    setTimeout(() => {
                                        window.location.href = `/results/${this.jobId}`;
                                    }, 1000);
                                }
                                // Continuer à vérifier si l'analyse est toujours en cours
                                else if (data.status === 'running' || data.status === 'queued') {
                                    setTimeout(checkStatus, 2000);
                                }
                            })
                            .catch(error => {
                                console.error('Erreur lors de la récupération du statut:', error);
                                setTimeout(checkStatus, 5000);
                            });
                    };
                    
                    checkStatus();
                },
                
                stopAnalysis() {
                    if (!this.jobId) return;
                    
                    fetch(`/api/stop/${this.jobId}`)
                        .then(response => response.json())
                        .then(data => {
                            this.jobStatus = data;
                            console.log('Analyse arrêtée:', data);
                        })
                        .catch(error => {
                            console.error('Erreur lors de l\'arrêt de l\'analyse:', error);
                            alert('Erreur lors de l\'arrêt de l\'analyse.');
                        });
                },
                
                forceCompleteAnalysis() {
                    if (!this.jobId) return;
                    
                    fetch(`/api/force-complete/${this.jobId}`)
                        .then(response => response.json())
                        .then(data => {
                            this.jobStatus = data;
                            console.log('Analyse forcée à terminer:', data);
                        })
                        .catch(error => {
                            console.error('Erreur lors de la complétion forcée de l\'analyse:', error);
                            alert('Erreur lors de la complétion forcée de l\'analyse.');
                        });
                },
                
                viewResults() {
                    window.location.href = `/results/${this.jobId}`;
                },
                
                getStatusBadgeClass(status) {
                    switch (status) {
                        case 'completed': return 'bg-success';
                        case 'failed': return 'bg-danger';
                        case 'running': return 'bg-primary';
                        case 'queued': return 'bg-warning';
                        default: return 'bg-secondary';
                    }
                },
                
                getStatusLabel(status) {
                    switch (status) {
                        case 'completed': return 'Terminé';
                        case 'failed': return 'Échoué';
                        case 'running': return 'En cours';
                        case 'queued': return 'En attente';
                        default: return 'Inconnu';
                    }
                },
                
                getLogIcon(message) {
                    if (message.includes('Fichier de contenu chargé')) {
                        return '<i class="bi bi-file-earmark-text text-primary"></i>';
                    } else if (message.includes('Fichier de liens existants chargé')) {
                        return '<i class="bi bi-link text-primary"></i>';
                    } else if (message.includes('Fichier GSC chargé')) {
                        return '<i class="bi bi-bar-chart text-primary"></i>';
                    } else if (message.includes('embeddings')) {
                        return '<i class="bi bi-cpu text-primary"></i>';
                    } else if (message.includes('Analyse de la page')) {
                        return '<i class="bi bi-arrow-repeat text-primary"></i>';
                    } else if (message.includes('terminé')) {
                        return '<i class="bi bi-check-circle text-success"></i>';
                    } else {
                        return '<i class="bi bi-arrow-repeat text-primary"></i>';
                    }
                },
                
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleString();
                },
                
                // Méthode pour lancer l'analyse avec les fichiers pré-remplis
                showGscImportNotification() {
                    this.gscNotificationVisible = true;
                    // Masquer la notification après 10 secondes
                    setTimeout(() => {
                        this.gscNotificationVisible = false;
                    }, 10000);
                },
                
                clearGscData() {
                    // Effacer les données GSC du localStorage
                    localStorage.removeItem('gscFilePath');
                    this.gscFilePath = null;
                    alert('Les données GSC ont été effacées. Vous pouvez maintenant télécharger un nouveau fichier GSC.');
                },
                
                startAnalysisWithPrefilledFiles() {
                    // Vérifier que nous avons un fichier de contenu valide
                    const hasContentFile = this.contentFilePath && this.contentFilePath !== 'null' && this.contentFilePath !== 'undefined';
                    const hasGscFile = this.gscFilePath && this.gscFilePath !== 'null' && this.gscFilePath !== 'undefined';
                    
                    if (!hasContentFile) {
                        alert('Vous devez fournir un fichier de contenu pour lancer l\'analyse.');
                        return;
                    }
                    
                    // Préparer les données pour l'analyse
                    const formData = new FormData();
                    
                    // Construire les chemins complets des fichiers
                    if (hasContentFile) {
                        const fullContentPath = this.contentFilePath.startsWith('app/uploads/') 
                            ? this.contentFilePath 
                            : `app/uploads/${this.contentFilePath}`;
                        formData.append('content_file', fullContentPath);
                        console.log('Chemin complet du fichier de contenu:', fullContentPath);
                    }
                    
                    if (this.linksFilePath && this.linksFilePath !== 'null' && this.linksFilePath !== 'undefined') {
                        const fullLinksPath = this.linksFilePath.startsWith('app/uploads/') 
                            ? this.linksFilePath 
                            : `app/uploads/${this.linksFilePath}`;
                        formData.append('links_file', fullLinksPath);
                        console.log('Chemin complet du fichier de liens:', fullLinksPath);
                    }
                    
                    if (hasGscFile) {
                        const fullGscPath = this.gscFilePath.startsWith('app/uploads/') 
                            ? this.gscFilePath 
                            : `app/uploads/${this.gscFilePath}`;
                        formData.append('gsc_file', fullGscPath);
                        console.log('Chemin complet du fichier GSC:', fullGscPath);
                    }
                    
                    // Ajouter la configuration
                    formData.append('config', JSON.stringify(this.config));
                    
                    // Lancer l'analyse
                    fetch('/api/analyze', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.job_id) {
                            this.jobId = data.job_id;
                            this.connectWebSocket();
                        } else {
                            alert('Erreur lors du lancement de l\'analyse: ' + (data.error || 'Erreur inconnue'));
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        alert('Erreur lors du lancement de l\'analyse: ' + error.message);
                    });
                }
            };
        }
    </script>
{% endblock %}
