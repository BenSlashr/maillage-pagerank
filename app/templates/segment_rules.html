{% extends "layout.html" %}

{% block title %}Règles de segmentation - SEO Internal Linking Tool{% endblock %}

{% block styles %}
<style>
    .rule-card {
        margin-bottom: var(--space-4);
        border-left: 4px solid var(--primary);
        border-radius: var(--radius);
        transition: transform 0.2s ease;
    }
    .rule-card:hover {
        transform: translateY(-2px);
    }
    .rule-card.regex {
        border-left-color: var(--secondary);
    }
    .rule-priority-high {
        background-color: rgba(16, 185, 129, 0.1);
    }
    .rule-priority-medium {
        background-color: rgba(245, 158, 11, 0.1);
    }
    .rule-priority-low {
        background-color: rgba(100, 116, 139, 0.1);
    }
    .segment-badge {
        font-size: 0.85rem;
        padding: 0.35em 0.65em;
    }
    .rule-actions {
        white-space: nowrap;
    }
    .priority-badge {
        min-width: 30px;
    }
    #rulesList {
        max-height: 600px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0"><i class="bi bi-tags me-2"></i>Règles de segmentation</h1>
    <div class="d-flex">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-primary" id="importRulesBtn">
                <i class="bi bi-file-arrow-up me-1"></i> Importer
            </button>
            <button type="button" class="btn btn-outline-secondary" id="exportRulesBtn">
                <i class="bi bi-file-arrow-down me-1"></i> Exporter
            </button>
        </div>
        <button type="button" class="btn btn-primary" id="addRuleBtn">
            <i class="bi bi-plus-lg me-1"></i> Ajouter une règle
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow rounded-lg">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-tag me-2"></i>Segment par défaut</h5>
            </div>
            <div class="card-body">
                <p>Le segment par défaut est attribué aux pages qui ne correspondent à aucune règle.</p>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="defaultSegment" placeholder="Segment par défaut">
                    <button class="btn btn-primary" type="button" id="saveDefaultSegmentBtn">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow rounded-lg">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-check2-circle me-2"></i>Tester une règle</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="testUrl" placeholder="Entrez une URL à tester">
                    <button class="btn btn-primary" type="button" id="testRuleBtn">Tester</button>
                </div>
                <div id="testResult" class="mt-3 d-none">
                    <div class="alert alert-success" role="alert">
                        <h5 class="alert-heading">Résultat du test</h5>
                        <p id="testResultText"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow rounded-lg">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Liste des règles</h5>
                <div>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Rechercher une règle..." id="searchRules">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" id="rulesList">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Pattern</th>
                                <th>Segment</th>
                                <th>Priorité</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rulesTableBody">
                            <!-- Les règles seront insérées ici dynamiquement -->
                        </tbody>
                    </table>
                    <div id="noRulesMessage" class="text-center p-4 d-none">
                        <p class="text-muted">Aucune règle définie. Cliquez sur "Ajouter une règle" pour commencer.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ajouter/modifier une règle -->
<div class="modal fade" id="ruleModal" tabindex="-1" aria-labelledby="ruleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ruleModalLabel">Ajouter une règle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="ruleIndex" value="-1">
                    <div class="mb-3">
                        <label for="pattern" class="form-label">Pattern</label>
                        <input type="text" class="form-control" id="pattern" required>
                        <div class="form-text">Motif à rechercher dans l'URL (ex: /blog/ ou /produits/)</div>
                    </div>
                    <div class="mb-3">
                        <label for="segment" class="form-label">Segment</label>
                        <input type="text" class="form-control" id="segment" required>
                        <div class="form-text">Type de page (ex: blog, produit, catégorie)</div>
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priorité</label>
                        <select class="form-select" id="priority">
                            <option value="3">Haute</option>
                            <option value="2" selected>Moyenne</option>
                            <option value="1">Basse</option>
                        </select>
                        <div class="form-text">Les règles de priorité plus élevée sont appliquées en premier</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isRegex">
                        <label class="form-check-label" for="isRegex">Expression régulière</label>
                        <div class="form-text">Cochez si le pattern est une expression régulière</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveRuleBtn">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cette règle ?</p>
                <p id="deleteRuleDetails" class="font-monospace"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'importation -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Importer des règles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFile" class="form-label">Fichier JSON</label>
                    <input class="form-control" type="file" id="importFile" accept=".json">
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="importMode" id="importModeReplace" value="replace" checked>
                        <label class="form-check-label" for="importModeReplace">
                            Remplacer toutes les règles existantes
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="importMode" id="importModeAppend" value="append">
                        <label class="form-check-label" for="importModeAppend">
                            Ajouter aux règles existantes
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmImportBtn">Importer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Application de gestion des règles de segmentation
const segmentRulesApp = {
    rules: [],
    defaultSegment: 'page',
    editIndex: -1,
    
    init() {
        // Charger les règles depuis le serveur
        this.loadRules();
        
        // Événements pour les boutons
        document.getElementById('addRuleBtn').addEventListener('click', () => this.showAddRuleModal());
        document.getElementById('saveRuleBtn').addEventListener('click', () => this.saveRule());
        document.getElementById('testRuleBtn').addEventListener('click', () => this.testRule());
        document.getElementById('saveDefaultSegmentBtn').addEventListener('click', () => this.saveDefaultSegment());
        document.getElementById('importRulesBtn').addEventListener('click', () => this.showImportModal());
        document.getElementById('exportRulesBtn').addEventListener('click', () => this.exportRules());
        document.getElementById('confirmImportBtn').addEventListener('click', () => this.importRules());
        document.getElementById('confirmDeleteBtn').addEventListener('click', () => this.deleteRule());
        document.getElementById('searchRules').addEventListener('input', (e) => this.filterRules(e.target.value));
        document.getElementById('clearSearchBtn').addEventListener('click', () => {
            document.getElementById('searchRules').value = '';
            this.filterRules('');
        });
    },
    
    // Charger les règles depuis le serveur
    loadRules() {
        fetch(`${basePath}/api/segment_rules`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.rules = data.rules || [];
                    this.defaultSegment = data.default_segment || 'page';
                    document.getElementById('defaultSegment').value = this.defaultSegment;
                    this.renderRules();
                } else if (data.message === 'undefined' || !data.message) {
                    // Cas où aucun segment n'est configuré - c'est normal pour un premier usage
                    console.log('Aucun segment configuré - initialisation avec des valeurs par défaut');
                    this.rules = [];
                    this.defaultSegment = 'page';
                    document.getElementById('defaultSegment').value = this.defaultSegment;
                    this.renderRules();
                } else {
                    console.error('Erreur lors du chargement des règles:', data.message);
                    alert('Erreur lors du chargement des règles: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des règles:', error);
                // Vérifier si c'est une première utilisation (fichier non trouvé)
                if (error.message && error.message.includes('not found')) {
                    this.rules = [];
                    this.defaultSegment = 'page';
                    document.getElementById('defaultSegment').value = this.defaultSegment;
                    this.renderRules();
                } else {
                    alert('Erreur lors du chargement des règles. Veuillez réessayer.');
                }
            });
    },
    
    // Afficher les règles dans le tableau
    renderRules() {
        const tableBody = document.getElementById('rulesTableBody');
        const noRulesMessage = document.getElementById('noRulesMessage');
        
        // Vider le tableau
        tableBody.innerHTML = '';
        
        // Afficher un message si aucune règle
        if (this.rules.length === 0) {
            noRulesMessage.classList.remove('d-none');
            return;
        }
        
        // Masquer le message s'il y a des règles
        noRulesMessage.classList.add('d-none');
        
        // Trier les règles par priorité (décroissante)
        const sortedRules = [...this.rules].sort((a, b) => b.priority - a.priority);
        
        // Ajouter chaque règle au tableau
        sortedRules.forEach((rule, i) => {
            const tr = document.createElement('tr');
            
            // Déterminer la classe de priorité
            let priorityClass = '';
            let priorityText = '';
            
            switch (parseInt(rule.priority)) {
                case 3:
                    priorityClass = 'bg-success';
                    priorityText = 'Haute';
                    break;
                case 2:
                    priorityClass = 'bg-warning';
                    priorityText = 'Moyenne';
                    break;
                case 1:
                    priorityClass = 'bg-secondary';
                    priorityText = 'Basse';
                    break;
            }
            
            tr.innerHTML = `
                <td><code>${rule.pattern}</code></td>
                <td><span class="badge bg-info">${rule.segment}</span></td>
                <td><span class="badge ${priorityClass}">${priorityText}</span></td>
                <td>
                    ${rule.is_regex ? 
                        '<span class="badge bg-primary">Regex</span>' : 
                        '<span class="badge bg-secondary">Simple</span>'}
                </td>
                <td class="rule-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="segmentRulesApp.showEditRuleModal(${i})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="segmentRulesApp.showDeleteConfirmModal(${i})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(tr);
        });
    },
    
    // Afficher le modal pour ajouter une règle
    showAddRuleModal() {
        // Réinitialiser le formulaire
        document.getElementById('ruleForm').reset();
        document.getElementById('ruleIndex').value = -1;
        document.getElementById('ruleModalLabel').textContent = 'Ajouter une règle';
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('ruleModal'));
        modal.show();
    },
    
    // Afficher le modal pour modifier une règle
    showEditRuleModal(index) {
        const rule = this.rules[index];
        
        // Remplir le formulaire avec les données de la règle
        document.getElementById('pattern').value = rule.pattern;
        document.getElementById('segment').value = rule.segment;
        document.getElementById('priority').value = rule.priority;
        document.getElementById('isRegex').checked = rule.is_regex;
        document.getElementById('ruleIndex').value = index;
        document.getElementById('ruleModalLabel').textContent = 'Modifier la règle';
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('ruleModal'));
        modal.show();
    },
    
    // Afficher le modal de confirmation de suppression
    showDeleteConfirmModal(index) {
        const rule = this.rules[index];
        this.editIndex = index;
        
        // Afficher les détails de la règle
        document.getElementById('deleteRuleDetails').innerHTML = `
            Pattern: <strong>${rule.pattern}</strong><br>
            Segment: <strong>${rule.segment}</strong><br>
            Type: <strong>${rule.is_regex ? 'Expression régulière' : 'Simple'}</strong>
        `;
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    },
    
    // Afficher le modal d'importation
    showImportModal() {
        // Réinitialiser le formulaire
        document.getElementById('importFile').value = '';
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('importModal'));
        modal.show();
    },
    
    // Enregistrer une règle (ajout ou modification)
    saveRule() {
        // Récupérer les données du formulaire
        const index = parseInt(document.getElementById('ruleIndex').value);
        const pattern = document.getElementById('pattern').value.trim();
        const segment = document.getElementById('segment').value.trim();
        const priority = parseInt(document.getElementById('priority').value);
        const isRegex = document.getElementById('isRegex').checked;
        
        // Valider les données
        if (!pattern || !segment) {
            alert('Veuillez remplir tous les champs obligatoires.');
            return;
        }
        
        // Créer l'objet règle
        const rule = {
            pattern,
            segment,
            priority,
            is_regex: isRegex
        };
        
        // Ajouter ou modifier la règle
        if (index === -1) {
            // Ajouter une nouvelle règle
            this.rules.push(rule);
        } else {
            // Modifier une règle existante
            this.rules[index] = rule;
        }
        
        // Enregistrer les règles sur le serveur
        this.saveRules();
        
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('ruleModal'));
        modal.hide();
    },
    
    // Supprimer une règle
    deleteRule() {
        // Supprimer la règle
        this.rules.splice(this.editIndex, 1);
        
        // Enregistrer les règles sur le serveur
        this.saveRules();
        
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        modal.hide();
    },
    
    // Enregistrer le segment par défaut
    saveDefaultSegment() {
        const defaultSegment = document.getElementById('defaultSegment').value.trim();
        
        if (!defaultSegment) {
            alert('Veuillez entrer un segment par défaut.');
            return;
        }
        
        this.defaultSegment = defaultSegment;
        this.saveRules();
    },
    
    // Enregistrer les règles sur le serveur
    saveRules() {
        const data = {
            rules: this.rules,
            default_segment: this.defaultSegment
        };
        
        fetch(`${basePath}/api/segment_rules`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.renderRules();
            } else {
                console.error('Erreur lors de l\'enregistrement des règles:', data.message);
                alert('Erreur lors de l\'enregistrement des règles: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur lors de l\'enregistrement des règles:', error);
            alert('Erreur lors de l\'enregistrement des règles. Veuillez réessayer.');
        });
    },
    
    // Exporter les règles
    exportRules() {
        const data = {
            rules: this.rules,
            default_segment: this.defaultSegment
        };
        
        // Créer un objet Blob pour le fichier JSON
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        
        // Créer un lien de téléchargement
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'segment_rules.json';
        
        // Cliquer sur le lien pour télécharger le fichier
        document.body.appendChild(a);
        a.click();
        
        // Nettoyer
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 0);
    },
    
    // Importer des règles
    importRules() {
        const fileInput = document.getElementById('importFile');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Veuillez sélectionner un fichier.');
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                
                // Vérifier si le fichier contient des règles
                if (!data.rules || !Array.isArray(data.rules)) {
                    throw new Error('Le fichier ne contient pas de règles valides.');
                }
                
                // Déterminer le mode d'importation
                const mode = document.querySelector('input[name="importMode"]:checked').value;
                
                if (mode === 'replace') {
                    // Remplacer toutes les règles
                    this.rules = data.rules;
                    
                    // Mettre à jour le segment par défaut si présent
                    if (data.default_segment) {
                        this.defaultSegment = data.default_segment;
                        document.getElementById('defaultSegment').value = this.defaultSegment;
                    }
                } else {
                    // Ajouter aux règles existantes
                    this.rules = [...this.rules, ...data.rules];
                }
                
                // Enregistrer les règles sur le serveur
                this.saveRules();
                
                // Fermer le modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                modal.hide();
            } catch (error) {
                console.error('Erreur lors de l\'importation des règles:', error);
                alert('Erreur lors de l\'importation des règles: ' + error.message);
            }
        };
        
        reader.readAsText(file);
    },
    
    // Filtrer les règles
    filterRules(query) {
        if (!query) {
            // Afficher toutes les règles
            this.renderRules();
            return;
        }
        
        query = query.toLowerCase();
        
        // Filtrer les règles
        const filteredRules = this.rules.filter(rule => 
            rule.pattern.toLowerCase().includes(query) ||
            rule.segment.toLowerCase().includes(query)
        );
        
        // Sauvegarder les règles originales
        const originalRules = this.rules;
        
        // Remplacer temporairement les règles par les règles filtrées
        this.rules = filteredRules;
        
        // Afficher les règles filtrées
        this.renderRules();
        
        // Restaurer les règles originales
        this.rules = originalRules;
    },
    
    // Échapper les caractères HTML
    escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    },
    
    // Tester si une URL correspond à la règle
    testRule() {
        const url = document.getElementById('testUrl').value.trim();
        const resultElement = document.getElementById('testResult');
        
        if (!url) {
            alert('Veuillez entrer une URL à tester.');
            return;
        }
        
        // Afficher le résultat
        resultElement.classList.remove('d-none');
        
        // Tester chaque règle
        let matched = false;
        let matchedRule = null;
        
        // Trier les règles par priorité (décroissante)
        const sortedRules = [...this.rules].sort((a, b) => b.priority - a.priority);
        
        for (const rule of sortedRules) {
            let pattern = rule.pattern;
            
            if (rule.is_regex) {
                // Tester avec une expression régulière
                try {
                    const regex = new RegExp(pattern);
                    if (regex.test(url)) {
                        matched = true;
                        matchedRule = rule;
                        break;
                    }
                } catch (error) {
                    console.error('Erreur dans l\'expression régulière:', error);
                }
            } else {
                // Tester avec une correspondance simple
                if (url.includes(pattern)) {
                    matched = true;
                    matchedRule = rule;
                    break;
                }
            }
        }
        
        // Afficher le résultat
        const resultText = document.getElementById('testResultText');
        
        if (matched) {
            resultText.innerHTML = `
                <strong>L'URL correspond à la règle suivante :</strong><br>
                Pattern: <code>${this.escapeHtml(matchedRule.pattern)}</code><br>
                Segment: <span class="badge bg-info">${this.escapeHtml(matchedRule.segment)}</span><br>
                Type: ${matchedRule.is_regex ? 
                    '<span class="badge bg-primary">Expression régulière</span>' : 
                    '<span class="badge bg-secondary">Simple</span>'}
            `;
            resultElement.className = 'mt-3 alert alert-success';
        } else {
            resultText.innerHTML = `
                <strong>L'URL ne correspond à aucune règle.</strong><br>
                Segment attribué par défaut : <span class="badge bg-secondary">${this.escapeHtml(this.defaultSegment)}</span>
            `;
            resultElement.className = 'mt-3 alert alert-warning';
        }
    }
};

// Initialiser l'application
document.addEventListener('DOMContentLoaded', () => {
    segmentRulesApp.init();
});
</script>
{% endblock %}
